<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Hipotecaria Avanzada | Prestamigo</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #e74c3c;
            --info: #2980b9;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: #f5f7fa;
            padding: 0;
            margin: 0;
        }
        
        .calculator-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .input-column {
            flex: 1;
            min-width: 280px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            position: relative;
        }
        
        .tooltip {
            display: inline-block;
            margin-left: 5px;
            width: 18px;
            height: 18px;
            background-color: var(--info);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 18px;
            cursor: help;
            position: relative;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 14px;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 18px;
            font-size: 16px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        
        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            display: block;
            margin: 25px auto;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .results {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background-color: var(--light);
            border-radius: 5px;
        }
        
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .card {
            flex: 1;
            min-width: 220px;
            padding: 18px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .card h3 {
            margin-top: 0;
            color: var(--secondary);
            font-size: 18px;
        }
        
        .card .amount {
            font-size: 26px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .card .subtext {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin: 30px 0;
        }
        
        .chart-box {
            flex: 1;
            min-width: 300px;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            overflow-x: auto;
            display: block;
        }
        
        .amortization-table th, .amortization-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .amortization-table th {
            background-color: var(--primary);
            color: white;
            text-align: center;
        }
        
        .amortization-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .savings {
            background-color: rgba(46, 204, 113, 0.1);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--success);
            margin: 20px 0;
        }
        
        .savings h3 {
            color: var(--success);
            margin-top: 0;
        }
        
        .disclaimer {
            font-size: 13px;
            color: #7f8c8d;
            margin-top: 35px;
            padding: 18px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--warning);
        }
        
        .comparison-results {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }
        
        .comparison-column {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .comparison-column h3 {
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        @media (max-width: 768px) {
            .input-group, .summary-cards, .chart-container, .comparison-results {
                flex-direction: column;
            }
            
            .card, .comparison-column {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <h1>Calculadora Hipotecaria Avanzada</h1>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="openTab('purchase')">Compra</button>
            <button class="tab-btn" onclick="openTab('refinance')">Refinanciamiento</button>
            <button class="tab-btn" onclick="openTab('extra-payments')">Pagos Extra</button>
        </div>
        
        <!-- Purchase Tab -->
        <div id="purchase" class="tab-content active">
            <div class="input-group">
                <div class="input-column">
                    <label for="home-price">Precio de la vivienda ($):
                        <span class="tooltip">?<span class="tooltip-text">Precio total de la propiedad que desea comprar</span></span>
                    </label>
                    <input type="number" id="home-price" value="300000" min="50000" step="1000">
                    
                    <label for="down-payment">Pago inicial ($):
                        <span class="tooltip">?<span class="tooltip-text">Cantidad de dinero que pagará al momento de la compra</span></span>
                    </label>
                    <input type="number" id="down-payment" value="60000" min="0" step="1000">
                    
                    <label for="down-payment-percent">Pago inicial (%):
                        <span class="tooltip">?<span class="tooltip-text">Porcentaje del precio de la vivienda que pagará inicialmente</span></span>
                    </label>
                    <input type="number" id="down-payment-percent" value="20" min="0" max="100" step="1">
                </div>
                
                <div class="input-column">
                    <label for="loan-term">Plazo del préstamo (años):
                        <span class="tooltip">?<span class="tooltip-text">Tiempo que tendrá para pagar el préstamo</span></span>
                    </label>
                    <select id="loan-term">
                        <option value="10">10 años</option>
                        <option value="15">15 años</option>
                        <option value="20">20 años</option>
                        <option value="30" selected>30 años</option>
                    </select>
                    
                    <label for="interest-rate">Tasa de interés (%):
                        <span class="tooltip">?<span class="tooltip-text">Tasa de interés anual del préstamo (APR)</span></span>
                    </label>
                    <input type="number" id="interest-rate" value="6.5" min="1" max="20" step="0.01">
                    
                    <label for="apr">APR (%):
                        <span class="tooltip">?<span class="tooltip-text">Tasa porcentual anual que incluye tarifas y costos</span></span>
                    </label>
                    <input type="number" id="apr" value="6.75" min="1" max="20" step="0.01">
                </div>
                
                <div class="input-column">
                    <label for="property-tax">Impuestos anuales ($):
                        <span class="tooltip">?<span class="tooltip-text">Impuestos prediales estimados por año</span></span>
                    </label>
                    <input type="number" id="property-tax" value="3600" min="0" step="100">
                    
                    <label for="home-insurance">Seguro del hogar anual ($):
                        <span class="tooltip">?<span class="tooltip-text">Costo estimado del seguro de vivienda</span></span>
                    </label>
                    <input type="number" id="home-insurance" value="1200" min="0" step="100">
                    
                    <label for="pmi">PMI (%):
                        <span class="tooltip">?<span class="tooltip-text">Seguro de hipoteca privada (solo si pago inicial < 20%)</span></span>
                    </label>
                    <input type="number" id="pmi" value="0.5" min="0" max="2" step="0.01" disabled>
                </div>
            </div>
            
            <button id="calculate-btn" onclick="calculateMortgage()">Calcular Pago Mensual</button>
            
            <div id="results" class="results">
                <h2>Resumen de tu Hipoteca</h2>
                
                <div class="summary-cards">
                    <div class="card">
                        <h3>Pago Mensual</h3>
                        <div class="amount" id="monthly-payment">$0</div>
                        <div class="subtext">Principal + Interés + Impuestos + Seguro</div>
                    </div>
                    <div class="card">
                        <h3>Préstamo Total</h3>
                        <div class="amount" id="total-loan">$0</div>
                        <div class="subtext">Monto total del préstamo</div>
                    </div>
                    <div class="card">
                        <h3>Interés Total</h3>
                        <div class="amount" id="total-interest">$0</div>
                        <div class="subtext">Interés pagado durante el plazo</div>
                    </div>
                    <div class="card">
                        <h3>Costo Total</h3>
                        <div class="amount" id="total-cost">$0</div>
                        <div class="subtext">Precio de la vivienda + Interés + Costos</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-box">
                        <h3 class="chart-title">Composición del Pago Mensual</h3>
                        <canvas id="payment-chart" width="400" height="400"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3 class="chart-title">Distribución de Pagos</h3>
                        <canvas id="amortization-chart" width="400" height="400"></canvas>
                    </div>
                </div>
                
                <h3>Tabla de Amortización (Primeros 12 meses)</h3>
                <div style="overflow-x: auto;">
                    <table class="amortization-table">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Pago</th>
                                <th>Principal</th>
                                <th>Interés</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="amortization-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Refinance Tab -->
        <div id="refinance" class="tab-content">
            <div class="input-group">
                <div class="input-column">
                    <label for="refi-current-balance">Saldo actual del préstamo ($):</label>
                    <input type="number" id="refi-current-balance" value="250000" min="1000" step="1000">
                    
                    <label for="refi-current-rate">Tasa de interés actual (%):</label>
                    <input type="number" id="refi-current-rate" value="7.5" min="1" max="20" step="0.01">
                    
                    <label for="refi-remaining-term">Plazo restante (años):</label>
                    <input type="number" id="refi-remaining-term" value="25" min="1" max="40" step="1">
                </div>
                
                <div class="input-column">
                    <label for="refi-new-rate">Nueva tasa de interés (%):</label>
                    <input type="number" id="refi-new-rate" value="6.0" min="1" max="20" step="0.01">
                    
                    <label for="refi-new-term">Nuevo plazo (años):</label>
                    <select id="refi-new-term">
                        <option value="10">10 años</option>
                        <option value="15">15 años</option>
                        <option value="20">20 años</option>
                        <option value="30" selected>30 años</option>
                    </select>
                    
                    <label for="refi-costs">Costos de refinanciamiento ($):</label>
                    <input type="number" id="refi-costs" value="5000" min="0" step="100">
                </div>
            </div>
            
            <button onclick="calculateRefinance()">Comparar Refinanciamiento</button>
            
            <div id="refi-results" class="results" style="display: none;">
                <h2>Comparación de Refinanciamiento</h2>
                
                <div class="comparison-results">
                    <div class="comparison-column">
                        <h3>Hipoteca Actual</h3>
                        <p><strong>Pago Mensual:</strong> <span id="current-monthly">$0</span></p>
                        <p><strong>Interés Total Restante:</strong> <span id="current-total-interest">$0</span></p>
                        <p><strong>Fecha de Pago Final:</strong> <span id="current-end-date">MM/AAAA</span></p>
                    </div>
                    
                    <div class="comparison-column">
                        <h3>Hipoteca Refinanciada</h3>
                        <p><strong>Pago Mensual:</strong> <span id="refi-monthly">$0</span></p>
                        <p><strong>Interés Total:</strong> <span id="refi-total-interest">$0</span></p>
                        <p><strong>Fecha de Pago Final:</strong> <span id="refi-end-date">MM/AAAA</span></p>
                    </div>
                </div>
                
                <div class="savings">
                    <h3>Ahorros Estimados</h3>
                    <p><strong>Ahorro Mensual:</strong> <span id="monthly-savings">$0</span></p>
                    <p><strong>Ahorro Total de Interés:</strong> <span id="total-savings">$0</span></p>
                    <p><strong>Punto de Equilibrio:</strong> <span id="break-even">0 meses</span> (cuando los ahorros cubren los costos)</p>
                </div>
                
                <div class="chart-container">
                    <div class="chart-box">
                        <h3 class="chart-title">Comparación de Intereses</h3>
                        <canvas id="refi-interest-chart" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Extra Payments Tab -->
        <div id="extra-payments" class="tab-content">
            <div class="input-group">
                <div class="input-column">
                    <label for="extra-loan-amount">Monto del préstamo ($):</label>
                    <input type="number" id="extra-loan-amount" value="250000" min="1000" step="1000">
                    
                    <label for="extra-interest-rate">Tasa de interés (%):</label>
                    <input type="number" id="extra-interest-rate" value="6.5" min="1" max="20" step="0.01">
                    
                    <label for="extra-loan-term">Plazo del préstamo (años):</label>
                    <select id="extra-loan-term">
                        <option value="15">15 años</option>
                        <option value="20">20 años</option>
                        <option value="30" selected>30 años</option>
                    </select>
                </div>
                
                <div class="input-column">
                    <label for="extra-payment-amount">Monto de pago extra ($):</label>
                    <input type="number" id="extra-payment-amount" value="200" min="0" step="10">
                    
                    <label for="extra-payment-frequency">Frecuencia:</label>
                    <select id="extra-payment-frequency">
                        <option value="1">Mensual</option>
                        <option value="12">Anual</option>
                        <option value="0">Único pago</option>
                    </select>
                    
                    <label for="extra-start-month">Comenzar en el mes:</label>
                    <input type="number" id="extra-start-month" value="1" min="1" step="1">
                </div>
            </div>
            
            <button onclick="calculateExtraPayments()">Calcular Ahorros</button>
            
            <div id="extra-results" class="results" style="display: none;">
                <h2>Resultados de Pagos Extra</h2>
                
                <div class="savings">
                    <h3>Ahorros Totales</h3>
                    <p><strong>Interés Ahorrado:</strong> <span id="interest-saved">$0</span></p>
                    <p><strong>Tiempo Ahorrado:</strong> <span id="time-saved">0 meses</span></p>
                    <p><strong>Nueva Fecha de Pago Final:</strong> <span id="new-end-date">MM/AAAA</span></p>
                </div>
                
                <div class="chart-container">
                    <div class="chart-box">
                        <h3 class="chart-title">Comparación de Saldos</h3>
                        <canvas id="extra-payments-chart" width="400" height="400"></canvas>
                    </div>
                </div>
                
                <h3>Tabla de Amortización con Pagos Extra</h3>
                <div style="overflow-x: auto;">
                    <table class="amortization-table">
                        <thead>
                            <tr>
                                <th>Año</th>
                                <th>Pago Regular</th>
                                <th>Pagos Extra</th>
                                <th>Principal</th>
                                <th>Interés</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="extra-amortization-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="disclaimer">
            <p><strong>Nota:</strong> Esta calculadora proporciona estimaciones solamente. Los resultados no constituyen una oferta de préstamo. Para obtener información precisa sobre su hipoteca, consulte con un originador de préstamos con licencia. Los impuestos y seguros pueden variar según la ubicación.</p>
            <p>INCITE LLC, DBA Prestamigo, es una empresa de educación. No somos un prestamista ni brindamos asesoramiento financiero personalizado.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let paymentChart, amortizationChart, refiInterestChart, extraPaymentsChart;
        
        // Tab navigation
        function openTab(tabName) {
            const tabs = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            const buttons = document.getElementsByClassName('tab-btn');
            for (let i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // Sync down payment $ and %
        document.getElementById('down-payment').addEventListener('input', function() {
            const homePrice = parseFloat(document.getElementById('home-price').value);
            const downPayment = parseFloat(this.value);
            const percent = (downPayment / homePrice * 100).toFixed(1);
            document.getElementById('down-payment-percent').value = percent;
            togglePMI(percent);
        });
        
        document.getElementById('down-payment-percent').addEventListener('input', function() {
            const homePrice = parseFloat(document.getElementById('home-price').value);
            const percent = parseFloat(this.value);
            const amount = (homePrice * percent / 100).toFixed(0);
            document.getElementById('down-payment').value = amount;
            togglePMI(percent);
        });
        
        function togglePMI(percent) {
            const pmiInput = document.getElementById('pmi');
            if (percent < 20) {
                pmiInput.disabled = false;
                pmiInput.value = "0.5";
            } else {
                pmiInput.disabled = true;
                pmiInput.value = "0";
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Format date
        function formatDate(monthsToAdd) {
            const today = new Date();
            today.setMonth(today.getMonth() + monthsToAdd);
            return (today.getMonth() + 1) + '/' + today.getFullYear();
        }
        
        // Calculate monthly payment
        function calculatePayment(principal, rate, term) {
            const monthlyRate = rate / 12;
            const payments = term * 12;
            return principal * monthlyRate / (1 - Math.pow(1 + monthlyRate, -payments));
        }
        
        // Main mortgage calculation
        function calculateMortgage() {
            // Get input values
            const homePrice = parseFloat(document.getElementById('home-price').value);
            const downPayment = parseFloat(document.getElementById('down-payment').value);
            const loanTerm = parseInt(document.getElementById('loan-term').value);
            const interestRate = parseFloat(document.getElementById('interest-rate').value) / 100;
            const apr = parseFloat(document.getElementById('apr').value) / 100;
            const propertyTax = parseFloat(document.getElementById('property-tax').value) / 12;
            const homeInsurance = parseFloat(document.getElementById('home-insurance').value) / 12;
            const pmiRate = parseFloat(document.getElementById('pmi').value) / 100;
            
            // Calculate loan details
            const loanAmount = homePrice - downPayment;
            const monthlyPI = calculatePayment(loanAmount, interestRate, loanTerm);
            
            // Calculate PMI if down payment < 20%
            let monthlyPMI = 0;
            if (downPayment < homePrice * 0.2) {
                monthlyPMI = (loanAmount * pmiRate) / 12;
            }
            
            // Total monthly payment
            const monthlyPayment = monthlyPI + monthlyPMI + propertyTax + homeInsurance;
            
            // Calculate totals
            const totalLoan = monthlyPI * loanTerm * 12;
            const totalInterest = totalLoan - loanAmount;
            const totalCost = homePrice + totalInterest + (monthlyPMI * loanTerm * 12) + 
                            (propertyTax * 12 * loanTerm) + (homeInsurance * 12 * loanTerm);
            
            // Display results
            document.getElementById('monthly-payment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('total-loan').textContent = formatCurrency(loanAmount);
            document.getElementById('total-interest').textContent = formatCurrency(totalInterest);
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);
            
            // Show results section
            document.getElementById('results').style.display = 'block';
            
            // Generate amortization table
            generateAmortizationTable(loanAmount, interestRate, monthlyPI, loanTerm * 12);
            
            // Generate charts
            generatePaymentChart(monthlyPI, monthlyPMI, propertyTax, homeInsurance);
            generateAmortizationChart(loanAmount, interestRate, monthlyPI, loanTerm * 12);
        }
        
        // Generate amortization table
        function generateAmortizationTable(principal, rate, monthlyPayment, numberOfPayments) {
            let balance = principal;
            let html = '';
            let totalInterest = 0;
            
            for (let month = 1; month <= 12; month++) {
                const interest = balance * rate / 12;
                const principalPayment = monthlyPayment - interest;
                balance -= principalPayment;
                totalInterest += interest;
                
                html += `
                    <tr>
                        <td>${month}</td>
                        <td>${formatCurrency(monthlyPayment)}</td>
                        <td>${formatCurrency(principalPayment)}</td>
                        <td>${formatCurrency(interest)}</td>
                        <td>${formatCurrency(balance)}</td>
                    </tr>
                `;
            }
            
            document.getElementById('amortization-body').innerHTML = html;
        }
        
        // Generate payment composition chart
        function generatePaymentChart(principalAndInterest, pmi, tax, insurance) {
            const ctx = document.getElementById('payment-chart').getContext('2d');
            
            if (paymentChart) {
                paymentChart.destroy();
            }
            
            paymentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Principal e Interés', 'PMI', 'Impuestos', 'Seguro'],
                    datasets: [{
                        data: [principalAndInterest, pmi, tax, insurance],
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#2ecc71',
                            '#f39c12'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Generate amortization chart
        function generateAmortizationChart(principal, rate, monthlyPayment, numberOfPayments) {
            const ctx = document.getElementById('amortization-chart').getContext('2d');
            let balance = principal;
            let labels = [];
            let principalData = [];
            let interestData = [];
            
            for (let year = 1; year <= 30; year++) {
                let yearlyPrincipal = 0;
                let yearlyInterest = 0;
                
                for (let month = 1; month <= 12; month++) {
                    const interest = balance * rate / 12;
                    const principalPayment = monthlyPayment - interest;
                    balance -= principalPayment;
                    
                    yearlyPrincipal += principalPayment;
                    yearlyInterest += interest;
                }
                
                labels.push(`Año ${year}`);
                principalData.push(yearlyPrincipal);
                interestData.push(yearlyInterest);
                
                if (balance <= 0) break;
            }
            
            if (amortizationChart) {
                amortizationChart.destroy();
            }
            
            amortizationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Principal',
                            data: principalData,
                            backgroundColor: '#3498db',
                        },
                        {
                            label: 'Interés',
                            data: interestData,
                            backgroundColor: '#e74c3c',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Refinance calculation
        function calculateRefinance() {
            const currentBalance = parseFloat(document.getElementById('refi-current-balance').value);
            const currentRate = parseFloat(document.getElementById('refi-current-rate').value) / 100;
            const remainingTerm = parseInt(document.getElementById('refi-remaining-term').value);
            const newRate = parseFloat(document.getElementById('refi-new-rate').value) / 100;
            const newTerm = parseInt(document.getElementById('refi-new-term').value);
            const refiCosts = parseFloat(document.getElementById('refi-costs').value);
            
            // Calculate current loan details
            const currentMonthly = calculatePayment(currentBalance, currentRate, remainingTerm);
            const currentRemainingPayments = remainingTerm * 12;
            const currentTotalInterest = calculateTotalInterest(currentBalance, currentRate, currentMonthly, currentRemainingPayments);
            
            // Calculate new loan details
            const newMonthly = calculatePayment(currentBalance, newRate, newTerm);
            const newTotalInterest = calculateTotalInterest(currentBalance, newRate, newMonthly, newTerm * 12);
            
            // Calculate savings
            const monthlySavings = currentMonthly - newMonthly;
            const totalSavings = currentTotalInterest - newTotalInterest - refiCosts;
            const breakEvenMonths = Math.ceil(refiCosts / monthlySavings);
            
            // Display results
            document.getElementById('current-monthly').textContent = formatCurrency(currentMonthly);
            document.getElementById('current-total-interest').textContent = formatCurrency(currentTotalInterest);
            document.getElementById('current-end-date').textContent = formatDate(currentRemainingPayments);
            
            document.getElementById('refi-monthly').textContent = formatCurrency(newMonthly);
            document.getElementById('refi-total-interest').textContent = formatCurrency(newTotalInterest);
            document.getElementById('refi-end-date').textContent = formatDate(newTerm * 12);
            
            document.getElementById('monthly-savings').textContent = formatCurrency(monthlySavings);
            document.getElementById('total-savings').textContent = formatCurrency(totalSavings);
            document.getElementById('break-even').textContent = breakEvenMonths + ' meses (' + Math.floor(breakEvenMonths/12) + ' años ' + (breakEvenMonths%12) + ' meses)';
            
            // Show results
            document.getElementById('refi-results').style.display = 'block';
            
            // Generate interest comparison chart
            generateRefiInterestChart(currentTotalInterest, newTotalInterest, refiCosts);
        }
        
        // Calculate total interest for a loan
        function calculateTotalInterest(principal, rate, monthlyPayment, numberOfPayments) {
            let balance = principal;
            let totalInterest = 0;
            
            for (let i = 0; i < numberOfPayments; i++) {
                const interest = balance * rate / 12;
                const principalPayment = monthlyPayment - interest;
                balance -= principalPayment;
                totalInterest += interest;
                
                if (balance <= 0) break;
            }
            
            return totalInterest;
        }
        
        // Generate refinance interest chart
        function generateRefiInterestChart(currentInterest, newInterest, costs) {
            const ctx = document.getElementById('refi-interest-chart').getContext('2d');
            
            if (refiInterestChart) {
                refiInterestChart.destroy();
            }
            
            refiInterestChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Interés Actual', 'Interés Nuevo', 'Costos de Refi'],
                    datasets: [{
                        label: 'Comparación de Costos',
                        data: [currentInterest, newInterest, costs],
                        backgroundColor: [
                            '#e74c3c',
                            '#2ecc71',
                            '#f39c12'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Extra payments calculation
        function calculateExtraPayments() {
            const loanAmount = parseFloat(document.getElementById('extra-loan-amount').value);
            const interestRate = parseFloat(document.getElementById('extra-interest-rate').value) / 100;
            const loanTerm = parseInt(document.getElementById('extra-loan-term').value);
            const extraPayment = parseFloat(document.getElementById('extra-payment-amount').value);
            const frequency = parseInt(document.getElementById('extra-payment-frequency').value);
            const startMonth = parseInt(document.getElementById('extra-start-month').value);
            
            // Calculate regular loan
            const monthlyPayment = calculatePayment(loanAmount, interestRate, loanTerm);
            const regularTotalInterest = calculateTotalInterest(loanAmount, interestRate, monthlyPayment, loanTerm * 12);
            const regularEndDate = formatDate(loanTerm * 12);
            
            // Calculate with extra payments
            let balance = loanAmount;
            let totalInterest = 0;
            let totalExtraPayments = 0;
            let monthsSaved = 0;
            let html = '';
            let yearlyData = [];
            let regularBalanceData = [];
            let extraBalanceData = [];
            
            // Calculate regular amortization for comparison
            let regularBalance = loanAmount;
            let regularPayments = [];
            
            for (let i = 1; i <= loanTerm * 12; i++) {
                const interest = regularBalance * interestRate / 12;
                const principal = monthlyPayment - interest;
                regularBalance -= principal;
                regularPayments.push({
                    balance: regularBalance,
                    interest: interest
                });
                
                if (regularBalance <= 0) break;
            }
            
            // Calculate with extra payments
            let paymentCount = 0;
            let extraPaymentCount = 0;
            let yearlySummary = {
                year: 1,
                regularPayment: 0,
                extraPayment: 0,
                principal: 0,
                interest: 0,
                balance: loanAmount
            };
            
            while (balance > 0 && paymentCount < loanTerm * 12 * 2) {
                paymentCount++;
                const interest = balance * interestRate / 12;
                let principal = monthlyPayment - interest;
                let currentExtra = 0;
                
                // Apply extra payment if applicable
                if (paymentCount >= startMonth && 
                    (frequency === 1 || 
                     (frequency === 12 && paymentCount % 12 === startMonth % 12) || 
                     (frequency === 0 && paymentCount === startMonth))) {
                    currentExtra = extraPayment;
                    extraPaymentCount++;
                }
                
                principal += currentExtra;
                balance -= principal;
                totalInterest += interest;
                totalExtraPayments += currentExtra;
                
                // Yearly summary
                yearlySummary.regularPayment += monthlyPayment;
                yearlySummary.extraPayment += currentExtra;
                yearlySummary.principal += principal;
                yearlySummary.interest += interest;
                yearlySummary.balance = balance <= 0 ? 0 : balance;
                
                if (paymentCount % 12 === 0 || balance <= 0) {
                    yearlyData.push(yearlySummary);
                    regularBalanceData.push(regularPayments[paymentCount - 1]?.balance || 0);
                    extraBalanceData.push(yearlySummary.balance);
                    
                    html += `
                        <tr>
                            <td>${yearlySummary.year}</td>
                            <td>${formatCurrency(yearlySummary.regularPayment)}</td>
                            <td>${formatCurrency(yearlySummary.extraPayment)}</td>
                            <td>${formatCurrency(yearlySummary.principal - yearlySummary.extraPayment)}</td>
                            <td>${formatCurrency(yearlySummary.interest)}</td>
                            <td>${formatCurrency(yearlySummary.balance)}</td>
                        </tr>
                    `;
                    
                    yearlySummary = {
                        year: yearlySummary.year + 1,
                        regularPayment: 0,
                        extraPayment: 0,
                        principal: 0,
                        interest: 0,
                        balance: balance
                    };
                }
                
                if (balance <= 0) {
                    monthsSaved = (loanTerm * 12) - paymentCount;
                    break;
                }
            }
            
            // Display results
            document.getElementById('interest-saved').textContent = formatCurrency(regularTotalInterest - totalInterest);
            document.getElementById('time-saved').textContent = monthsSaved + ' meses (' + Math.floor(monthsSaved/12) + ' años)';
            document.getElementById('new-end-date').textContent = formatDate(paymentCount);
            document.getElementById('extra-amortization-body').innerHTML = html;
            
            // Show results
            document.getElementById('extra-results').style.display = 'block';
            
            // Generate chart
            generateExtraPaymentsChart(regularBalanceData, extraBalanceData, loanTerm);
        }
        
        // Generate extra payments chart
        function generateExtraPaymentsChart(regularData, extraData, term) {
            const ctx = document.getElementById('extra-payments-chart').getContext('2d');
            const labels = [];
            
            for (let i = 1; i <= term; i++) {
                labels.push(`Año ${i}`);
            }
            
            if (extraPaymentsChart) {
                extraPaymentsChart.destroy();
            }
            
            extraPaymentsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Saldo sin Pagos Extra',
                            data: regularData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Saldo con Pagos Extra',
                            data: extraData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>